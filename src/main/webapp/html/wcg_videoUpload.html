<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>个人视频上传</title>
<!--base css-->
<link type="text/css" rel="stylesheet" href="../css/base.css">
<!--layui css-->
<!--<link rel="stylesheet" href="../layui/css/layui.css">-->
<!--会影响原网页字体-->
<link rel="stylesheet" href="../layui/css/layui.mobile.css">
<link rel="stylesheet" href="../layui/css/modules/code.css">
<link rel="stylesheet"
	href="../layui/css/modules/laydate/default/laydate.css">
<!--self css-->
<link rel="stylesheet" href="../css/wcg_userInfo.css">
<!--jquery-3.3.1 js-->
<script type="text/javascript" src="../js/jquery-3.3.1.js"></script>
<!--layui js-->
<script src="../layui/layui.all.js"></script>
<script src="../layui/layui.js"></script>
<script src="../layui/lay/modules/carousel.js"></script>
<script src="../layui/lay/modules/code.js"></script>
<script src="../layui/lay/modules/colorpicker.js"></script>
<script src="../layui/lay/modules/element.js"></script>
<script src="../layui/lay/modules/flow.js"></script>
<script src="../layui/lay/modules/form.js"></script>
<script src="../layui/lay/modules/jquery.js"></script>
<script src="../layui/lay/modules/laydate.js"></script>
<script src="../layui/lay/modules/layedit.js"></script>
<script src="../layui/lay/modules/layer.js"></script>
<script src="../layui/lay/modules/laypage.js"></script>
<script src="../layui/lay/modules/laytpl.js"></script>
<script src="../layui/lay/modules/mobile.js"></script>
<script src="../layui/lay/modules/rate.js"></script>
<script src="../layui/lay/modules/slider.js"></script>
<script src="../layui/lay/modules/table.js"></script>
<script src="../layui/lay/modules/tree.js"></script>
<script src="../layui/lay/modules/upload.js"></script>
<script src="../layui/lay/modules/util.js"></script>
<!--myself js-->
<script type="text/javascript" src="../js/wcg_homePage.js"></script>
</head>
<body>
	<div id="top">
		<!-- 用户信息 -->
		<div style="display: none">
			<!-- 1/0 -->
			<input type="text" id="isLogin" value="0" /> <input type="text"
				id="userId" value="" /> <input type="text" id="userPhone" value="" />
			<input type="text" id="userPower" value="" /> <input type="text"
				id="userName" value="" /> <input type="text" id="userSex" value="" />
			<input type="text" id="userAddress" value="" /> <input type="text"
				id="userBirthday" value="" /> <input type="text" id="userIntroduce"
				value="" /> <input type="text" id="userImage" value="" />
		</div>
		<div id="top_in">
			<!--Logo-->
			<div id="logo">
				<a href="homepage.html">
					<div></div>
				</a>
			</div>
			<!--首页-->
			<div id="home">
				<a href="homepage.html">
					<div></div>
					<p>首页</p>
				</a>
			</div>
			<!--导航-->
			<div id="nav" onclick="showForNav()">
				<a style="cursor: pointer;">
					<div id="navLogo"></div>
					<p>导视</p>
				</a>
				<div id="forNav" onmouseleave="hideForNav()" style="display: none">
					<ul>
						<li><a href="homepage.html#movie">电影</a></li>
						<li><a href="homepage.html#tv">电视</a></li>
						<li><a href="homepage.html#upV">上传</a></li>
					</ul>
				</div>
			</div>
			<!--搜索栏-->
			<div id="search">
				<div id="key_word">
					<div onclick="getVideoByName()"></div>
					<input type="text" name="search" onkeyup="getVideoByFirstName()" />
				</div>
				<div id="search_button">
					<button onclick="getVideoByName()">搜库</button>
				</div>
				<div id="forSearch">
					<ul>
					</ul>
				</div>
			</div>
			<!--头像-->
			<div id="photo" onmouseenter="showForPhoto()"
				style="cursor: pointer;">
				<a id="tou">
					<div id="photoImg" onclick="ShowLoginText()"></div>
				</a>
				<div id="forPhoto" hidden onmouseleave="hideForPhoto()">
					<ul>
						<li><a href="wcg_personalInfoChange.html"
							style="cursor: pointer;">修改信息</a></li>
						<li><a id="logout" onclick="logOut()"
							style="cursor: pointer;">退出登录</a></li>
					</ul>
				</div>
			</div>
			<!--上传-->
			<div id="upload">
				<a onclick="upload()" style="cursor: pointer;">
					<div></div>
				</a>
			</div>
			<!--历史-->
			<div id="history">
				<div id="historyImg" onclick="showHistory()"
					style="cursor: pointer;"></div>
				<div id="forHistory" onmouseleave="hideHistory()" hidden></div>
			</div>
			<!--收藏-->
			<div id="collect">
				<a onclick="collection()" style="cursor: pointer;">
					<div></div>
				</a>
			</div>
			<!--片库-->
			<div id="searchLib" style="cursor: pointer;">
				<a href="film_library.html">
					<div></div>
				</a>
			</div>
		</div>
	</div>
	<div id="body">
		<div id="kongbai"></div>
		<div
			style="width: 1080px; height: 600px; background-color: rgba(15, 15, 15, 0.2)">
			<div
				style="width: 1000px; height: 500px; float: left; margin-top: 50px; margin-left: 40px">
				<h1>视频上传</h1>
				<input type="file" accept="video/*" id="video" name="video"
					style="float: left; width: 900px; margin-left: 50px; margin-right: 50px; padding: 0; margin-top: 50px"
					onchange="getVideoSrc(event)" />
				<div style="float: left; margin-left: 50px; margin-top: 40px;">
					上传视频的名称：<input type="text" id="uploadVideoName" />(可选)
				</div>
				<input type="button"
					style="width: 80px; height: 40px; margin-top: 30px; margin-left: 50px; border: 0px; border-radius: 5px; background-color: #31b6ff; color: white; font-size: 15px; cursor: pointer;"
					onclick="upload()" value="上传" />
				<div class="modal-body"
					style="color: black; margin-left: 50px; margin-top: 30px;">
					上传进度：
					<progress style="width: 30em;"></progress>
					<p id="info" style="margin-top: 10px"></p>
				</div>
			</div>
		</div>
	</div>
	<div id="footer">
		<p>Copyright©2019 泉青酷 weteam.online 版权所有</p>
	</div>
</body>
<script type="text/javascript">
	var video;
	/*视频转换base64*/
	var videoSrc;
	var totalSize = 0;/*文件大小*/
	function getVideoSrc(event) {
		video = event.target.files[0];
		if (video != null && video != '') {
			var reader = new FileReader();
			reader.readAsDataURL(video);
			reader.onload = function(event) {
				videoSrc = event.target.result;
				totalSize = videoSrc.length;
				$("#info").html(
						"已上传/总大小： " + '0KB/' + Math.ceil(totalSize / 1000)
								+ "KB");
				console.log(videoSrc);
			}
		}
	}
	/*base64上传*/
	function upload() {
		var file = video;/*获取的文件*/
		if (file != null && file != '') {
			var fileName = file.name;/*文件名*/
			var ext;/*文件后缀*/
			var extIndex = fileName.lastIndexOf(".");
			ext = fileName.substring(extIndex + 1);
			videoName = fileName.substring(0, extIndex);
			var inputVideoName = $("#uploadVideoName").val();
			if (inputVideoName != null && inputVideoName != '') {
				videoName = inputVideoName;
				$.ajax({
					type : "post",
					url : "/infoChange/checkUpvName",
					data : {
						"videoName" : videoName
					},
					dataType : "text",
					success : function(result) {
						if (result == "1") {
							/*判断是否为视频文件*/
							if (ext != "mp4") {
								layer.msg('上传文件的格式有误');
							} else {
								$("#info").html(
										"已上传/总大小： " + '0KB/'
												+ Math.ceil(totalSize / 1000)
												+ "KB");

								videoSrc = videoSrc.split(",")[1];
								$.ajax({
									type : "post",
									url : "/infoChange/uploadVideo",
									data : {
										"videoName" : videoName,
										"stringVideo" : videoSrc
									},
									dataType : "text",
									xhr : function() { //获取ajaxSettings中的xhr对象，为它的upload属性绑定progress事件的处理函数
										myXhr = $.ajaxSettings.xhr();
										if (myXhr.upload) { //检查upload属性是否存在
											//绑定progress事件的回调函数
											myXhr.upload.addEventListener(
													'progress',
													progressHandlingFunction,
													false);
										}
										return myXhr; //xhr对象返回给jQuery使用
									},
									success : function(result) {
										if (result == "1") {
											console.log("上传成功");
										}
									}
								});
							}
						} else {
							layer.msg('这个视频名字用过了，换个试试');
						}
					}
				});
			}
		} else {
			layer.msg('请选择要上传的视频文件');
		}
	}

	//上传进度回调函数：
	function progressHandlingFunction(e) {
		total = Math.ceil(e.total / 1000);
		if (e.lengthComputable) {
			loaded = Math.ceil(e.loaded / 1000);
			$('progress').attr({
				value : loaded,
				max : total
			}); //更新数据到进度条
			var percent = loaded / total * 100;
			$('#info').html(
					loaded + "/" + total + " KB " + "<span>"
							+ percent.toFixed(2) + "</span>" + "%");
		}
	}
</script>
</html>